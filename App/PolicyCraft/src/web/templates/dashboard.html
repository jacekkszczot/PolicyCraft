{% extends "base.html" %}

{% block title %}Dashboard - PolicyCraft{% endblock %}

{% block content %}
<!-- 
    PolicyCraft - Dashboard Template
    
    This is the main dashboard that provides users with an overview of their
    policy analyses, statistics, and quick access to recent activities.
    
    Table of Contents:
    1. Hero Section - Welcome message and quick stats
    2. Statistics Overview - Key metrics and visualizations
    3. Recent Analyses - Table of recent policy analyses
    4. Interactive Elements - Export, filter, and manage analyses
    5. JavaScript Functions - Client-side interactivity
    
    Dynamic Content:
    - Personalized welcome message with user's name
    - Real-time statistics and metrics
    - Interactive data visualizations
    - Sortable and filterable analysis history
    - Responsive design for all device sizes
    
    Author: Jacek Robert Kszczot
    Project: MSc Data Science & AI - COM7016
    University: Leeds Trinity University
    Key Features:
    - Interactive data visualization
    - Real-time statistics updates
    - Export functionality for analysis data
    - Responsive table with pagination
    - Action buttons for each analysis
    - Confirmation dialogs for destructive actions
    
    JavaScript Functions:
    - toggleShowMore() - Toggle visibility of additional table rows
    - exportAnalysesTable() - Export analysis data to CSV
    - confirmDelete() - Show confirmation dialog before deletion
    
    Dependencies:
    - Bootstrap 5.3.0 (CSS/JS)
    - Chart.js for visualizations
    - Custom CSS from static/css/
    - Font Awesome 6.4.0 for icons
    
    Author: Jacek Robert Kszczot
    Project: MSc Data Science & AI - COM7016
    University: Leeds Trinity University
-->

<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <h1 class="hero-title">Policy Analysis Dashboard</h1>
        <h2 class="hero-subtitle">Comprehensive insights across university AI policies</h2>
        <div class="user-welcome">
            <p>Welcome back, <strong>{{ data.user.full_name or data.user.username }}</strong>!</p>
        </div>
    </div>
</section>

<div class="dashboard-container">

    {% if data.total_policies > 0 %}
    
    <!-- Statistics Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <h3>{{ data.total_policies }}</h3>
                <p>Total Policies Analysed</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-content">
                <h3>{{ data.statistics.avg_confidence or 0 }}%</h3>
                <p>Average Confidence</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üè∑Ô∏è</div>
            <div class="stat-content">
                <h3>{{ data.statistics.avg_themes_per_analysis or 0 }}</h3>
                <p>Avg Themes per Policy</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-content">
                <h3>{{ data.recent_analyses|length }}</h3>
                <p>Recent Analyses</p>
            </div>
        </div>
    </div>

    <!-- Classification Distribution -->
    <div class="dashboard-section">
        <h2>Policy Approach Distribution</h2>
        <div class="classification-visual">
            {% for classification, count in data.classification_counts.items() %}
            <div class="classification-bar">
                <div class="classification-info">
                    <span class="classification-label">{{ classification }}</span>
                    <span class="classification-count">{{ count }}</span>
                </div>
                <div class="bar-container">
                    <div class="bar bar-{{ classification.lower() }}" 
                         style="--w: {{ (count / data.total_policies * 100) }}%;"></div>
                </div>
                <span class="percentage">{{ "%.1f"|format(count / data.total_policies * 100) }}%</span>
            </div>
            {% endfor %}
        </div>
    </div>


    <!-- Recent Analyses Table -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2>Recent Analyses</h2>
            <div class="table-controls">
                <button id="showMoreBtn" class="btn btn-outline-dark text-dark" onclick="toggleShowMore()" style="display: none;">
                    Show More
                </button>
                <button class="btn btn-outline-dark text-dark" onclick="exportAnalysesTable()">
                    üìä Export
                </button>
            </div>
        </div>
        
        <div class="analyses-table-container">
            <table class="analyses-table">
                <thead>
                    <tr>
                        <th style="width:22%">üèõÔ∏è University</th>
                        <th style="width:20%">üìä Classification</th>
                        <th id="dateHeader" style="width:14%; cursor:pointer;">üìÖ Date <span class="sort-arrow">‚ñº</span></th>
                        <th style="width:20%">üéØ Top Themes</th>
                        <th>‚öôÔ∏è Actions</th>
                    </tr>
                </thead>
                <tbody id="analysesTableBody">
                    {% for analysis in data.recent_analyses %}
                    <tr class="analysis-row" {% if loop.index > 5 %}style="display: none;" data-hidden="true"{% endif %}>
                        <td class="university-cell">
                            <div class="university-info">
                                <div class="university-name">{{ analysis.filename|clean_university_name }}
                                </div>
                            </div>
                        </td>
                        
                        <td class="classification-cell">
                            <div class="classification-wrapper">
                                {% if analysis.classification is string %}
                                <span class="classification-badge classification-{{ analysis.classification.lower() }}">
                                    {{ analysis.classification }}
                                </span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="--w: {{ analysis.score if analysis.score else 0 }}%;"></div>
                                    <span class="confidence-text">{{ analysis.score if analysis.score else 0 }}%</span>
                                </div>
                                {% else %}
                                <span class="classification-badge classification-{{ analysis.classification.classification.lower() if analysis.classification else 'unknown' }}">
                                    {{ analysis.classification.classification if analysis.classification else 'Unknown' }}
                                </span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="--w: {{ analysis.classification.confidence if analysis.classification else 0 }}%;"></div>
                                    <span class="confidence-text">{{ analysis.classification.confidence if analysis.classification else 0 }}%</span>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="date-cell">
                            <div class="date-wrapper">
                                {% if analysis.analysis_date %}
                                    <span class="analysis-date" data-date="{{ analysis.analysis_date }}">{{ analysis.analysis_date|format_british_date }}</span>
                                {% else %}
                                    <span class="analysis-date">Unknown</span>
                                {% endif %}
                        </td>

                        
                        <td class="themes-cell">
                            <div class="themes-wrapper">
                                {% if analysis.themes %}
                                {% for theme in analysis.themes[:3] %}
                                <span class="theme-tag">{{ theme.name if theme.name else theme }}</span>
                                {% endfor %}
                                {% if analysis.themes|length > 3 %}
                                <span class="theme-more" title="{% for theme in analysis.themes[3:] %}{{ theme.name if theme.name else theme }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                    +{{ analysis.themes|length - 3 }} more
                                </span>
                                {% endif %}
                                {% else %}
                                <span class="no-themes">No themes</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="actions-cell">
                            <div class="action-buttons" style="display:flex; align-items:center; gap:8px;">
                                {% if analysis.is_placeholder or analysis.is_baseline or '[BASELINE]' in analysis.filename %}
    <a href="{{ url_for('analyse_document', filename=analysis.filename) }}" class="btn btn-view" style="padding:4px 12px; font-size:0.9rem;" title="View analysis">View</a>
    <span class="baseline-icon" style="font-size:1.6rem; line-height:1;" title="Base policy">üèÖ</span>
{% else %}
    <a href="{{ url_for('analyse_document', filename=analysis.filename) }}" class="btn btn-view" style="padding:4px 12px; font-size:0.9rem;" title="View analysis">View</a>
    <form method="POST" action="{{ url_for('delete_analysis', analysis_id=analysis._id) }}" onsubmit="return confirm('Delete this analysis?');" style="margin:0;">
        <button type="submit" class="btn btn-delete" style="padding:4px 12px; font-size:0.9rem;" title="Delete analysis">Delete</button>
    </form>
{% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-footer">
            <div class="results-count">
                Showing <span id="visibleCount">{{ [data.recent_analyses|length, 5]|min }}</span> 
                of <span id="totalCount">{{ data.recent_analyses|length }}</span> analyses
            </div>
        </div>
    </div>

    <!-- Sorting script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const header = document.getElementById('dateHeader');
        if(!header) return;
        let asc = false;
        header.addEventListener('click', function() {
            const tbody = document.getElementById('analysesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort(function(a, b) {
                const da = new Date(a.querySelector('.analysis-date').dataset.date || 0);
                const db = new Date(b.querySelector('.analysis-date').dataset.date || 0);
                return asc ? da - db : db - da;
            });
            rows.forEach((r,i) => {
                tbody.appendChild(r);
                if(i < 5){
                    r.style.display = '';
                    r.removeAttribute('data-hidden');
                } else {
                    r.style.display = 'none';
                    r.setAttribute('data-hidden','true');
                }
            });
            // update counts
            document.getElementById('visibleCount').textContent = Math.min(rows.length, 5);
            document.getElementById('totalCount').textContent = rows.length;
            asc = !asc;
            const arrow = header.querySelector('.sort-arrow');
            if (arrow) { arrow.textContent = asc ? '‚ñ≤' : '‚ñº'; }
        });
    });
    </script>

    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">üìÑ</div>
        <h2>No Analyses Yet</h2>
        <p>Upload your first AI policy document to get started.</p>
        <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-large">Upload Your First Document</a>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('upload_file') }}" class="action-button primary">
            <span class="action-icon">üì§</span>
            <span class="action-text">Upload New Policy</span>
        </a>
        <a href="{{ url_for('about') }}" class="action-button secondary">
            <span class="action-icon">‚ÑπÔ∏è</span>
            <span class="action-text">About</span>
        </a>
    </div>
</div>

<script>
let showingAll = false;

function toggleShowMore() {
    const hiddenRows = document.querySelectorAll('[data-hidden="true"]');
    const btn = document.getElementById('showMoreBtn');
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = parseInt(document.getElementById('totalCount').textContent);
    
    showingAll = !showingAll;
    
    hiddenRows.forEach(row => {
        row.style.display = showingAll ? 'table-row' : 'none';
    });
    
    btn.textContent = showingAll ? 'Show less' : 'Show more';
    visibleCount.textContent = showingAll ? totalCount : Math.min(5, totalCount);
}

function exportAnalysesTable() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "University,Classification,Confidence,Date,Top Themes\n";
    
    {% for analysis in data.recent_analyses %}
    const data{{ loop.index0 }} = [
        "{{ analysis.filename|clean_filename }}",
        {% if analysis.classification is string %}
        "{{ analysis.classification }}",
        {{ analysis.score if analysis.score else 0 }},
        {% else %}
        "{{ analysis.classification.classification if analysis.classification else 'Unknown' }}",
        {{ analysis.classification.confidence if analysis.classification else 0 }},
        {% endif %}
        "{{ analysis.analysis_date if analysis.analysis_date else 'Unknown' }}",
        "{% if analysis.themes %}{% for theme in analysis.themes[:3] %}{{ theme.name if theme.name else theme }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
    ];
    csvContent += `"${data{{ loop.index0 }}[0]}","${data{{ loop.index0 }}[1]}",${data{{ loop.index0 }}[2]},"${data{{ loop.index0 }}[3]}","${data{{ loop.index0 }}[4]}"\n`;
    {% endfor %}
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `policy_analyses_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}



// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const totalRows = {{ data.recent_analyses|length }};
    const showMoreBtn = document.getElementById('showMoreBtn');
    
    if (totalRows > 5) {
        showMoreBtn.style.display = 'inline-block';
    }
    
    // Animate confidence bars
    setTimeout(() => {
        const confidenceBars = document.querySelectorAll('.confidence-fill');
        confidenceBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }, 500);
});
</script>

{% endblock %}