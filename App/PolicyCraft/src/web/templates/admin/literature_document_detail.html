{% extends 'base.html' %}

{% block title %}Document Details - PolicyCraft Admin{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
/* Shared admin container styles to match Literature Dashboard */
.admin-container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
.admin-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
.admin-content::before { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 1; }
.admin-content > * { position: relative; z-index: 2; }

/* Hero section */
.hero-section { padding: 2.5rem 2rem 1.5rem 2rem; background: transparent; }
.hero-title { margin: 0; font-size: 2.2rem; font-weight: 700; color: #1f2937; }
.hero-subtitle { margin: 0.25rem 0 0 0; color: #6c757d; }

/* Breadcrumb */
.breadcrumb-nav { padding: 0 2rem; margin-bottom: 0.75rem; }
.breadcrumb-link { color: #0077cc; text-decoration: none; }
.breadcrumb-link:hover { text-decoration: underline; }
.breadcrumb-separator { margin: 0 0.5rem; color: #6c757d; }
.breadcrumb-current { color: #6c757d; }

/* Page header and sections */
.page-header { padding: 0 2rem 0.5rem 2rem; }
.page-title { margin: 0 0 0.25rem 0; font-weight: 600; color: #111827; }
.page-meta { margin: 0; color: #6c757d; }
.section-title { padding: 0 2rem; margin: 1rem 0 0.25rem 0; font-weight: 600; color: #333; }

/* Cards tweaks */
.card { border-radius: 12px; }

/* Dashboard-like boxes for details */
.detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; padding: 0 2rem 2rem 2rem; margin-bottom: 0.5rem; }
.detail-card { background: #fff; border-radius: 15px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid #e9ecef; }
.detail-card.border-green { border-left: 4px solid #28a745; }
.detail-card.border-purple { border-left: 4px solid #6f42c1; }
.detail-card.border-orange { border-left: 4px solid #fd7e14; }
.detail-card h4 { margin: 0 0 0.5rem 0; font-weight: 600; color: #333; }
.detail-kpi { text-align:center; }

/* Responsive */
@media (max-width: 768px) {
  .admin-container { margin: 1rem auto; padding: 0 0.5rem; }
  .hero-title { font-size: 1.8rem; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    alert('Document ID copied to clipboard');
  });
}
</script>
{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="admin-content">
    <!-- Hero Section -->
    <div class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">üìÑ Document Details</h1>
        <p class="hero-subtitle">View metadata, quality and files</p>
      </div>
    </div>

    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
      <a href="{{ url_for('admin.dashboard') }}" class="breadcrumb-link">Admin Dashboard</a>
      <span class="breadcrumb-separator">‚Üí</span>
      <a href="{{ url_for('admin.literature_knowledge_base') }}" class="breadcrumb-link">Knowledge Base</a>
      <span class="breadcrumb-separator">‚Üí</span>
      <span class="breadcrumb-current">Document Details</span>
    </nav>

    <!-- Header -->
    <div class="page-header">
      <h2 class="page-title">
        {% if doc.original_file_guess %}
          {{ doc.original_file_guess }}
        {% elif doc.metadata and (doc.metadata.title or doc.metadata.authors) %}
          {{ doc.metadata.title or doc.metadata.authors }}
        {% else %}
          {{ doc.filename or doc.document_id }}
        {% endif %}
      </h2>
      <p class="page-meta">
        {% if doc.metadata and doc.metadata.authors %}{{ doc.metadata.authors }}{% endif %}
        {% if doc.metadata and doc.metadata.journal %}
          ‚Ä¢ {{ doc.metadata.journal }}
        {% endif %}
        {% if doc.metadata and doc.metadata.publication_date %}
          ‚Ä¢ {{ doc.metadata.publication_date }}
        {% endif %}
      </p>
    </div>

  <!-- KPI Boxes -->
  <div class="detail-grid">
    <div class="detail-card border-green detail-kpi">
      <div class="text-uppercase text-muted small">Quality Score</div>
      {% set quality = doc.quality_score_parsed or (doc.metadata.quality_score if doc.metadata else None) %}
      <div class="display-6 fw-bold text-primary">
        {% if quality %}
          {% if quality is string and '%' not in quality %}{{ quality }}{% elif quality is string %}{{ quality }}{% else %}{{ "%.1f"|format(quality * 100) }}%{% endif %}
        {% else %}N/A{% endif %}
      </div>
    </div>

    <div class="detail-card border-purple detail-kpi">
      <div class="text-uppercase text-muted small">Insights Extracted</div>
      <div class="display-6 fw-bold text-primary">{{ doc.total_insights or (doc.insights|length if doc.insights else 0) }}</div>
    </div>

    <div class="detail-card border-orange detail-kpi">
      <div class="text-uppercase text-muted small">Confidence Level</div>
      <div class="display-6 fw-bold text-primary">{{ doc.confidence_level|default('N/A')|title }}</div>
    </div>
  </div>

  <!-- Files Section -->
  <h3 class="section-title">üìé Document Files</h3>
  <div class="detail-grid">
    <div class="detail-card border-purple">
      <div>
        <div class="d-flex align-items-center mb-2">
          <span class="text-uppercase text-muted small me-2">Original File</span>
          {% if doc.original_file_exists %}
            <span class="badge bg-success ms-auto">Available</span>
          {% else %}
            <span class="badge bg-danger ms-auto">Processed & Removed</span>
          {% endif %}
        </div>
        {% if doc.original_file_guess %}
          <div class="mb-2">
            <strong>Estimated original name:</strong><br>
            <code class="text-break d-inline-block">{{ doc.original_file_guess }}</code>
          </div>
        {% endif %}
        <small class="text-muted">Original PDF files are removed after processing to save storage.</small>
      </div>
    </div>
    <div class="detail-card border-orange">
      <div>
        <div class="d-flex align-items-center mb-2">
          <span class="text-uppercase text-muted small me-2">Generated Markdown</span>
          {% if doc.original_filename %}
            <span class="badge bg-success ms-auto">Available</span>
          {% else %}
            <span class="badge bg-danger ms-auto">Not Found</span>
          {% endif %}
        </div>
        {% if doc.original_filename %}
          <div class="mb-2">
            {% set filename = doc.original_filename %}
            {% if filename|length > 40 %}
              <code class="text-break d-inline-block small">{{ filename[:20] }}...{{ filename[-12:] }}</code>
            {% else %}
              <code class="text-break d-inline-block">{{ filename }}</code>
            {% endif %}
          </div>
          <div class="d-flex gap-2 align-items-center">
            <a href="{{ url_for('admin.literature_raw_file', filename=doc.original_filename) }}" target="_blank" class="btn btn-sm btn-primary">
              View Raw
            </a>
            <small class="text-muted">Size: {{ "%.1f KB"|format((doc.markdown_file_size or doc.file_size or 0) / 1024) }}</small>
          </div>
        {% else %}
          <span class="text-danger small">Not Found</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Document Information -->
  {% if doc.abstract %}
  <h3 class="section-title">üìã Abstract</h3>
  <div class="detail-grid" style="grid-template-columns: 1fr;">
    <div class="detail-card">
      <p class="mb-0">{{ doc.abstract }}</p>
    </div>
  </div>
  {% endif %}

  {% if doc.keywords %}
  <h3 class="section-title">üè∑Ô∏è Keywords</h3>
  <div class="detail-grid" style="grid-template-columns: 1fr;">
    <div class="detail-card">
      <p class="mb-0">{{ doc.keywords }}</p>
    </div>
  </div>
  {% endif %}

  <!-- Processing Information -->
  <h3 class="section-title">‚öôÔ∏è Processing Information</h3>
  <div class="detail-grid">
    <div class="detail-card border-green">
      <h4>Document ID</h4>
      {% set full_id = doc.document_id_full or doc.document_id or 'N/A' %}
      {% if full_id != 'N/A' and full_id|length > 50 %}
        <div class="mb-2">
          <code class="small">{{ full_id[:25] }}...{{ full_id[-15:] }}</code>
        </div>
        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ full_id }}')">
          Copy Full ID
        </button>
      {% else %}
        <code class="small text-break">{{ full_id }}</code>
      {% endif %}
    </div>
    <div class="detail-card border-purple">
      <h4>Processing Date</h4>
      <span>{{ doc.processing_date or 'N/A' }}</span>
    </div>
    <div class="detail-card border-orange">
      <h4>Integration Date</h4>
      <span>{{ doc.integration_date or 'N/A' }}</span>
    </div>
  </div>

  <div class="detail-grid">
    <div class="detail-card border-green">
      <h4>Content Stats</h4>
      <ul class="mb-0">
        <li>Total lines: {{ doc.lines_count or (doc.content.split('\n')|length if doc.content else 'N/A') }}</li>
        <li>Content length: {{ doc.content_length or (doc.content|length if doc.content else 'N/A') }} characters</li>
        <li>Insights extracted: {{ doc.total_insights or (doc.insights|length if doc.insights else 0) }}</li>
      </ul>
    </div>
    <div class="detail-card border-purple">
      <h4>Metadata</h4>
      {% if doc.metadata %}
      <ul class="mb-0">
        {% for key, value in doc.metadata.items() %}
        <li><strong>{{ key|title }}:</strong> {{ value }}</li>
        {% endfor %}
      </ul>
      {% else %}
      <span class="text-muted">No additional metadata available</span>
      {% endif %}
    </div>
  </div>

  <!-- Back button -->
  <div class="d-flex px-4 pb-4">
    <a href="{{ url_for('admin.literature_knowledge_base') }}" class="btn btn-secondary">
      ‚Üê Back to Knowledge Base
    </a>
  </div>
</div>
</div>
{% endblock %}
