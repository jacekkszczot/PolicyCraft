{% extends "base.html" %}

{% block title %}Dashboard - PolicyCraft{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <h1 class="hero-title">Policy Analysis Dashboard</h1>
        <h2 class="hero-subtitle">Comprehensive insights across university AI policies</h2>
        <div class="user-welcome">
            <p>Welcome back, <strong>{{ data.user.full_name or data.user.username }}</strong>!</p>
        </div>
    </div>
</section>

<div class="dashboard-container">

    {% if data.total_policies > 0 %}
    
    <!-- Statistics Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <h3>{{ data.total_policies }}</h3>
                <p>Total Policies Analysed</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-content">
                <h3>{{ data.statistics.avg_confidence or 0 }}%</h3>
                <p>Average Confidence</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üè∑Ô∏è</div>
            <div class="stat-content">
                <h3>{{ data.statistics.avg_themes_per_analysis or 0 }}</h3>
                <p>Avg Themes per Policy</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-content">
                <h3>{{ data.recent_analyses|length }}</h3>
                <p>Recent Analyses</p>
            </div>
        </div>
    </div>

    <!-- Classification Distribution -->
    <div class="dashboard-section">
        <h2>Policy Approach Distribution</h2>
        <div class="classification-visual">
            {% for classification, count in data.classification_counts.items() %}
            <div class="classification-bar">
                <div class="classification-info">
                    <span class="classification-label">{{ classification }}</span>
                    <span class="classification-count">{{ count }}</span>
                </div>
                <div class="bar-container">
                    <div class="bar bar-{{ classification.lower() }}" 
                         style="width: {{ (count / data.total_policies * 100) }}%"></div>
                </div>
                <span class="percentage">{{ "%.1f"|format(count / data.total_policies * 100) }}%</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Analyses Table -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2>Recent Analyses</h2>
            <div class="table-controls">
                <button id="showMoreBtn" class="btn btn-outline" onclick="toggleShowMore()" style="display: none;">
                    Show More
                </button>
                <button class="btn btn-outline" onclick="exportAnalysesTable()">
                    üìä Export
                </button>
            </div>
        </div>
        
        <div class="analyses-table-container">
            <table class="analyses-table">
                <thead>
                    <tr>
                        <th>üèõÔ∏è University</th>
                        <th>üìä Classification</th>
                        <th>üìÖ Date</th>
                        <th>üéØ Top Themes</th>
                        <th>‚öôÔ∏è Actions</th>
                    </tr>
                </thead>
                <tbody id="analysesTableBody">
                    {% for analysis in data.recent_analyses %}
                    <tr class="analysis-row" {% if loop.index > 5 %}style="display: none;" data-hidden="true"{% endif %}>
                        <td class="university-cell">
                            <div class="university-info">
                                <div class="university-name">{{ analysis.filename|clean_university_name }}
                                </div>
                                <div class="file-name">
                                    {{ analysis.filename|clean_filename }}
                                </div>
                            </div>
                        </td>
                        
                        <td class="classification-cell">
                            <div class="classification-wrapper">
                                <span class="classification-badge classification-{{ analysis.classification.classification.lower() if analysis.classification else 'unknown' }}">
                                    {{ analysis.classification.classification if analysis.classification else 'Unknown' }}
                                </span>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: {{ analysis.classification.confidence if analysis.classification else 0 }}%"></div>
                                    <span class="confidence-text">{{ analysis.classification.confidence if analysis.classification else 0 }}%</span>
                                </div>
                            </div>
                        </td>
                        
                        <td class="date-cell">
                            <div class="date-wrapper">
                                {% if analysis.analysis_date %}
                                    <span class="analysis-date">{{ analysis.analysis_date|format_british_date }}</span>
                                {% else %}
                                    <span class="analysis-date">Unknown</span>
                                {% endif %}
                        </td>
                        
                        <td class="themes-cell">
                            <div class="themes-wrapper">
                                {% if analysis.themes %}
                                {% for theme in analysis.themes[:3] %}
                                <span class="theme-tag">{{ theme.name if theme.name else theme }}</span>
                                {% endfor %}
                                {% if analysis.themes|length > 3 %}
                                <span class="theme-more" title="{% for theme in analysis.themes[3:] %}{{ theme.name if theme.name else theme }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                    +{{ analysis.themes|length - 3 }} more
                                </span>
                                {% endif %}
                                {% else %}
                                <span class="no-themes">No themes</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <a href="{{ url_for('analyse_document', filename=analysis.filename) }}"
                                   class="btn btn-view" title="View Analysis">
                                    üëÅÔ∏è View
                                </a>
                                
                                {% if not analysis.filename.startswith('[BASELINE]') and 'clean_dataset' not in analysis.filename %}
                                <form method="POST" action="{{ url_for('delete_analysis', analysis_id=analysis._id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this analysis?');">
                                    <button type="submit" class="btn btn-delete" title="Delete Analysis">
                                        üóëÔ∏è Delete
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-footer">
            <div class="results-count">
                Showing <span id="visibleCount">{{ [data.recent_analyses|length, 5]|min }}</span> 
                of <span id="totalCount">{{ data.recent_analyses|length }}</span> analyses
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">üìÑ</div>
        <h2>No Analyses Yet</h2>
        <p>Upload your first AI policy document to get started.</p>
        <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-large">Upload Your First Document</a>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('upload_file') }}" class="action-button primary">
            <span class="action-icon">üì§</span>
            <span class="action-text">Upload New Policy</span>
        </a>

        <a href="{{ url_for('about') }}" class="action-button secondary">
            <span class="action-icon">‚ÑπÔ∏è</span>
            <span class="action-text">About</span>
        </a>
    </div>
</div>

<script>
let showingAll = false;

function toggleShowMore() {
    const hiddenRows = document.querySelectorAll('[data-hidden="true"]');
    const btn = document.getElementById('showMoreBtn');
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = parseInt(document.getElementById('totalCount').textContent);
    
    showingAll = !showingAll;
    
    hiddenRows.forEach(row => {
        row.style.display = showingAll ? 'table-row' : 'none';
    });
    
    btn.textContent = showingAll ? 'Show Less' : 'Show More';
    visibleCount.textContent = showingAll ? totalCount : Math.min(5, totalCount);
}

function exportAnalysesTable() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "University,Classification,Confidence,Date,Top Themes\n";
    
    {% for analysis in data.recent_analyses %}
    const data{{ loop.index0 }} = [
        "{{ analysis.filename|clean_filename }}",
        "{{ analysis.classification.classification if analysis.classification else 'Unknown' }}",
        {{ analysis.classification.confidence if analysis.classification else 0 }},
        "{{ analysis.analysis_date if analysis.analysis_date else 'Unknown' }}",
        "{% if analysis.themes %}{% for theme in analysis.themes[:3] %}{{ theme.name if theme.name else theme }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
    ];
    csvContent += `"${data{{ loop.index0 }}[0]}","${data{{ loop.index0 }}[1]}",${data{{ loop.index0 }}[2]},"${data{{ loop.index0 }}[3]}","${data{{ loop.index0 }}[4]}"\n`;
    {% endfor %}
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `policy_analyses_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const totalRows = {{ data.recent_analyses|length }};
    const showMoreBtn = document.getElementById('showMoreBtn');
    
    if (totalRows > 5) {
        showMoreBtn.style.display = 'inline-block';
    }
    
    // Animate confidence bars
    setTimeout(() => {
        const confidenceBars = document.querySelectorAll('.confidence-fill');
        confidenceBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }, 500);
});
</script>

{% endblock %}