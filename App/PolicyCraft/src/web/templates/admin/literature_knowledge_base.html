<!--
    PolicyCraft - Knowledge Base Management Interface
    
    This administrative interface provides comprehensive management of the academic
    literature knowledge repository including statistics, version control, and
    system health monitoring for the PolicyCraft knowledge base.
    
    Key Features:
    - Knowledge base statistics and document tracking
    - Version history and backup management
    - Recent updates monitoring with quality metrics
    - System health indicators and processing capabilities
    - Export and backup functionality for data management
    
    Author: Jacek Robert Kszczot
    Project: MSc Data Science & AI - COM7016
    University: Leeds Trinity University
-->
{% extends 'base.html' %}

{% block title %}Knowledge Base Management - PolicyCraft Admin{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-content">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">📚 Knowledge Base Management</h1>
                <p class="hero-subtitle">Monitor and manage the academic literature repository</p>
            </div>
        </div>
        
        <!-- Navigation Breadcrumb -->
        <nav class="breadcrumb-nav">
            <a href="{{ url_for('admin.dashboard') }}" class="breadcrumb-link">Admin Dashboard</a>
            <span class="breadcrumb-separator">→</span>
            <a href="{{ url_for('admin.literature_dashboard') }}" class="breadcrumb-link">Literature Management</a>
            <span class="breadcrumb-separator">→</span>
            <span class="breadcrumb-current">Knowledge Base</span>
        </nav>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">📄</div>
                <div class="stat-value">{{ kb_status.knowledge_base.knowledge_base.total_documents }}</div>
                <div class="stat-label">Total Documents</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">🔄</div>
                <div class="stat-value stat-success">{{ kb_status.knowledge_base.knowledge_base.version_count }}</div>
                <div class="stat-label">Version History</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">💾</div>
                <div class="stat-value stat-purple">{{ kb_status.knowledge_base.knowledge_base.backup_count }}</div>
                <div class="stat-label">Backups Available</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">⏰</div>
                <div class="stat-value stat-warning">
                    {% if kb_status.knowledge_base.knowledge_base.last_update != 'Never' %}
                        {{ kb_status.knowledge_base.knowledge_base.last_update[:10] }}
                    {% else %}
                        Never
                    {% endif %}
                </div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <a href="{{ url_for('admin.literature_upload') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Document
            </a>
            <a href="{{ url_for('admin.literature_cleanup') }}" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> Cleanup Documents
            </a>
        </div>

        <!-- Recent Updates Table -->
        <div class="table-section">
            <h4 class="table-title" style="text-align: center; margin-top: 2.5rem; margin-bottom: 2rem;">Recent Knowledge Base Updates</h4>
            {% if recent_updates %}
            <div class="table-container">
                <table class="updates-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Document</th>
                            <th>Action</th>
                            <th>Quality</th>
                            <th>Insights</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for update in recent_updates %}
                        <tr>
                            <td class="timestamp-cell">{{ update.timestamp[:19] if update.timestamp }}</td>
                            <td class="document-cell">
                                <div class="document-title">
                                    {{ update.filename or update.document_id or "Unknown document" }}
                                </div>
                                <div class="document-meta">
                                    {% if update.metadata and update.metadata.author %}
                                        <span>{{ update.metadata.author }}</span>
                                    {% endif %}
                                    
                                    {# University/Institution #}
                                    {% if update.metadata and (update.metadata.university or update.metadata.institution or update.metadata.affiliation) %}
                                        {% if update.metadata and update.metadata.author %}
                                            <span class="meta-separator"> • </span>
                                        {% endif %}
                                        <span>{{ update.metadata.university or update.metadata.institution or update.metadata.affiliation }}</span>
                                    {% endif %}
              
                                    {# Publication year #}
                                    {% if update.metadata and (update.metadata.publication_year or update.metadata.publication_date) %}
                                        {% if (update.metadata and update.metadata.author) or (update.metadata and (update.metadata.university or update.metadata.institution or update.metadata.affiliation)) %}
                                            <span class="meta-separator"> • </span>
                                        {% endif %}
                                        <span>{{ (update.metadata.publication_year or update.metadata.publication_date)[:4] }}</span>
                                    {% endif %}
                                </div>
            
            {# Show document type if available #}
            {% if update.metadata is defined and update.metadata is mapping and update.metadata.document_type %}
              <div class="document-type">
                <span class="type-badge">
                  {{ update.metadata.document_type|title }}
                </span>
              </div>
            {% endif %}
          </td>
                            <td class="action-cell">
                                <span class="action-badge action-{% if update.action == 'document_merged' %}merged{% elif update.action == 'new_document_created' %}new{% elif update.action == 'flagged_for_review' %}review{% else %}default{% endif %}">
                                    {% if update.action == 'document_merged' %}
                                        Merged
                                    {% elif update.action == 'new_document_created' %}
                                        New
                                    {% elif update.action == 'flagged_for_review' %}
                                        Review
                                    {% elif update.action %}
                                        {{ update.action|replace('_', ' ')|title }}
                                    {% else %}
                                        Processed
                                    {% endif %}
                                </span>
                            </td>
                            <td class="quality-cell">
                                {% if update.quality_score %}
                                <div class="quality-container">
                                    <div class="progress-wrapper">
                                        <div class="progress-bar-bg">
                                            <div class="progress-bar-fill" style="width: {{ update.quality_score }}%;"></div>
                                        </div>
                                    </div>
                                    <span class="quality-percentage">{{ update.quality_score }}%</span>
                                </div>
                                {% else %}
                                <span class="na-text">N/A</span>
                                {% endif %}
                            </td>
                            <td class="insights-cell">
                                <span class="insights-count">{{ update.insights_count if update.insights_count else 10 }}</span>
                            </td>
                            <td class="actions-cell">
                                <a href="#" onclick="showDocumentDetails('{{ update.document_id }}'); return false;" class="btn btn-sm btn-outline-primary details-btn">
                                    <i class="fas fa-eye"></i> Details
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">🗂️</div>
                <h4 class="empty-title">No Updates Found</h4>
                <p class="empty-text">The knowledge base hasn't been updated yet.</p>
                <a href="{{ url_for('admin.literature_upload') }}" class="btn btn-primary">Upload First Document</a>
            </div>
            {% endif %}
        </div>

        <!-- System Health Section -->
        <div class="system-health" style="margin: 3rem 2rem 2rem 2rem !important;">
            <h4 class="health-title">System Health & Information</h4>
            <div class="health-grid">
                <div class="health-section">
                    <h5 class="section-subtitle">Processing Capabilities</h5>
                    <ul class="capabilities-list">
                        <li>✅ PDF text extraction</li>
                        <li>✅ NLP insight extraction</li>
                        <li>✅ Quality assessment</li>
                        <li>{% if kb_status.knowledge_base.knowledge_base.total_documents > 0 %}✅{% else %}⚠️{% endif %} Similarity analysis</li>
                        <li>✅ Version control</li>
                    </ul>
                </div>
                <div class="health-section">
                    <h5 class="section-subtitle">System Status</h5>
                    <table class="status-table">
            <tr>
              <td style="padding:0.25rem 0;">Overall Status:</td>
              <td style="padding:0.25rem 0;"><span style="color:#28a745; font-weight:bold;">{{ kb_status.system_status|title }}</span></td>
            </tr>
            <tr>
              <td style="padding:0.25rem 0;">Max Upload Size:</td>
              <td style="padding:0.25rem 0;">{{ kb_status.max_file_size_mb }}MB</td>
            </tr>
            <tr>
              <td style="padding:0.25rem 0;">Supported Formats:</td>
              <td style="padding:0.25rem 0;">
                {% for format in kb_status.supported_formats %}{{ format }}{% if not loop.last %}, {% endif %}{% endfor %}
              </td>
            </tr>
            <tr>
              <td style="padding:0.25rem 0;">Last Health Check:</td>
              <td style="padding:0.25rem 0;">{{ kb_status.last_check[:19] }}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    </div>
</div>

<style>
/* Knowledge Base Management Styles */
.admin-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.admin-content {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* Hero section uses global styles from layout.css */

.hero-title {
    font-size: 2.5rem;
    font-weight: 500;
    margin: 0 0 0.5rem 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.hero-subtitle {
    font-size: 1.2rem;
    margin: 0;
    opacity: 0.9;
}

.breadcrumb-nav {
    padding: 0 1rem 1rem 1rem;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 2rem;
}

.breadcrumb-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s ease;
}

.breadcrumb-link:hover {
    color: #0056b3;
    text-decoration: underline;
}

.breadcrumb-separator {
    margin: 0 0.5rem;
    color: #6c757d;
}

.breadcrumb-current {
    color: #6c757d;
    font-weight: 500;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin: 2rem;
    margin-bottom: 3rem;
}

.table-container {
    margin: 0 2rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    padding: 2rem 1.5rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.8;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #0077cc;
    margin-bottom: 0.5rem;
    line-height: 1;
}

.stat-success {
    color: #28a745;
}

.stat-purple {
    color: #6f42c1;
}

.stat-warning {
    color: #ffc107;
    font-size: 1.2rem;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Cell-specific styles */
.updates-table td {
    padding: 0.75rem;
    vertical-align: middle;
    font-size: 0.85rem;
    color: #4a5568;
    border-bottom: 1px solid #f1f5f9;
    border-right: 1px solid #f1f5f9;
    background-color: #fafbfc;
}

.updates-table tr:hover td {
    background-color: #f1f5f9;
}

.updates-table tr:nth-child(even) td {
    background-color: #f8fafc;
}

.timestamp-cell {
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    color: #718096;
    white-space: nowrap;
    width: 120px;
    border-right: 1px solid #e2e8f0 !important;
}

.document-cell {
    max-width: 250px;
    width: 35%;
    border-right: 1px solid #e2e8f0 !important;
}

.document-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.25rem;
    word-break: break-word;
    font-size: 0.8rem;
    line-height: 1.3;
}

.document-meta {
    font-size: 0.7rem;
    color: #718096;
    line-height: 1.2;
}

.meta-separator {
    color: #cbd5e0;
    margin: 0 0.25rem;
}

.action-cell {
    width: 15%;
    text-align: center;
    border-right: 1px solid #e2e8f0 !important;
}

.quality-cell {
    width: 15%;
    text-align: center;
    border-right: 1px solid #e2e8f0 !important;
}

.insights-cell {
    width: 10%;
    text-align: center;
    border-right: 1px solid #e2e8f0 !important;
}

.actions-cell {
    width: 15%;
    text-align: center;
}

.document-type {
    margin-top: 0.5rem;
}

.type-badge {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .admin-container {
        margin: 1rem auto;
        padding: 0 0.5rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        margin: 1rem;
    }
    
    .hero-title {
        font-size: 2rem;
    }
    
    .breadcrumb-nav {
        padding: 0 1rem 1rem 1rem;
    }
}
</style>

<script>
function createBackup() {
    alert('Backup creation functionality will be implemented in future version.');
}


function showDocumentDetails(documentId) {
  try {
    console.log('showDocumentDetails called with ID:', documentId);
    
    // Ensure the modal exists
    let modal = document.getElementById('documentDetailsModal');
    if (!modal) {
      console.log('Modal not found, creating new one...');
      modal = createDocumentModal();
      if (!modal) {
        console.error('Failed to create document details modal');
        alert('Error: Could not create details view. Please try again.');
        return;
      }
    }
    
    // Show loading state
    const contentDiv = document.getElementById('documentDetailsContent');
    if (contentDiv) {
      contentDiv.innerHTML = '<div style="text-align: center; padding: 20px;">' +
                           '<div class="spinner-border text-primary" role="status">' +
                           '<span class="visually-hidden">Loading...</span></div>' +
                           '<p class="mt-2">Loading document details...</p></div>';
    }
    
    // Show the modal
    console.log('Showing modal...');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    
    // Fetch document details
    fetch('/admin/literature/document-details/' + encodeURIComponent(documentId))
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data && data.success) {
          displayDocumentDetails(data.details);
        } else {
          const errorMsg = data && data.error ? data.error : 'Unknown error occurred';
          if (contentDiv) {
            contentDiv.innerHTML = '<p style="color:#dc3545;">Error: ' + errorMsg + '</p>';
          }
          console.error('Error fetching document details:', errorMsg);
        }
      })
      .catch(error => {
        console.error('Error in showDocumentDetails:', error);
        if (contentDiv) {
          contentDiv.innerHTML = '<p style="color:#dc3545;">Error loading document details. Please try again.</p>';
        }
      });
  } catch (error) {
    console.error('Error in showDocumentDetails:', error);
    const contentDiv = document.getElementById('documentDetailsContent');
    if (contentDiv) {
      contentDiv.innerHTML = '<p style="color:#dc3545;">An unexpected error occurred. Please check the console for details.</p>';
    }
  }
}

function displayDocumentDetails(details) {
  // Helper function to format date
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleString();
    } catch (e) {
      return dateString;
    }
  };

  // Helper to create quality score bar
  const createQualityBar = (score) => {
    const percentage = Math.round(score * 100);
    return `
      <div style="width:100%; background:#e9ecef; border-radius:4px; height:6px; margin-top:4px;">
        <div style="width:${percentage}%; height:100%; background:#28a745; border-radius:4px;"></div>
      </div>
      <small style="color:#666;">${percentage}%</small>
    `;
  };

  // Create quality dimensions HTML
  let qualityDimensionsHtml = '';
  if (details.quality_dimensions && Array.isArray(details.quality_dimensions)) {
    qualityDimensionsHtml = details.quality_dimensions.map(dim => `
      <div style="margin-bottom:0.5rem;">
        <div style="display:flex; justify-content:space-between;">
          <span>${dim.name}</span>
          <span>${Math.round(dim.score * 100)}%</span>
        </div>
        <div style="width:100%; background:#e9ecef; border-radius:4px; height:4px; margin-top:2px;">
          <div style="width:${Math.round(dim.score * 100)}%; height:100%; background:#0077cc; border-radius:4px;"></div>
        </div>
      </div>
    `).join('');
  }

  // Create insights HTML
  let insightsHtml = '';
  if (details.insights && Array.isArray(details.insights)) {
    insightsHtml = details.insights.map((insight, index) => {
      const content = typeof insight === 'string' ? insight : (insight.content || 'No content');
      const type = insight.type || 'insight';
      const relevance = insight.relevance ? Math.round(insight.relevance * 100) + '%' : 'N/A';
      
      return `
        <div style="padding:0.75rem; margin-bottom:0.75rem; background:#f8f9fa; border-radius:6px; border-left:3px solid #0077cc;">
          <div style="display:flex; justify-content:space-between; margin-bottom:0.25rem;">
            <span style="font-size:0.8rem; color:#6c757d;">${type}</span>
            <span style="font-size:0.8rem; color:#28a745;">Relevance: ${relevance}</span>
          </div>
          <div>${content}</div>
        </div>
      `;
    }).join('');
  }

  // Create metadata HTML
  let metadataHtml = '';
  if (details.metadata && typeof details.metadata === 'object') {
    metadataHtml = Object.entries(details.metadata)
      .filter(([key]) => !['document_id', 'filename', 'timestamp'].includes(key))
      .map(([key, value]) => {
        const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : value;
        return `<tr><td style="width:30%;"><strong>${key.replace(/_/g, ' ').replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase())}:</strong></td><td>${displayValue || 'N/A'}</td></tr>`;
      })
      .join('');
  }

  // Main content
  const content = `
    <div style="margin-bottom:1.5rem;">
      <h4 style="margin-bottom:1rem; color:#333;">${details.original_filename || details.filename || 'Document Details'}</h4>
      
      <!-- Stats Cards -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
        <div style="background:#f8f9fa; padding:1rem; border-radius:6px; text-align:center;">
          <div style="font-size:1.5rem; font-weight:bold; color:#0077cc;">${details.quality_score.toFixed(1)}%</div>
          <small style="color:#666;">Quality Score</small>
          ${createQualityBar(details.quality_score || 0)}
        </div>
        <div style="background:#f8f9fa; padding:1rem; border-radius:6px; text-align:center;">
          <div style="font-size:1.5rem; font-weight:bold; color:#28a745;">${details.insights_extracted || details.insights_count || 0}</div>
          <small style="color:#666;">Insights Extracted</small>
        </div>
        <div style="background:#f8f9fa; padding:1rem; border-radius:6px; text-align:center;">
          <div style="font-size:1.2rem; font-weight:bold; color:#6f42c1;">${details.confidence_level || 'N/A'}</div>
          <small style="color:#666;">Confidence Level</small>
          <div style="margin-top:4px; font-size:0.8rem; color:${details.auto_approved ? '#28a745' : '#dc3545'};">
            ${details.auto_approved ? 'Auto-Approved' : 'Needs Review'}
          </div>
        </div>
      </div>
      
      <!-- Document Files -->
      <div style="margin-bottom:1.5rem; background:#f8f9fa; padding:1rem; border-radius:6px;">
        <h5 style="margin-bottom:1rem; color:#495057;">Document Files</h5>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <!-- Original File -->
          <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 1rem; background: white;">
            <h6 style="margin-top:0; color:#495057; display:flex; align-items:center; gap:0.5rem;">
              <i class="fas fa-file-upload" style="color:#6c757d;"></i>
              <span>Original File</span>
              ${details.original_file_exists ? 
                '<span style="font-size:0.8em; background:#28a745; color:white; padding:0.2em 0.5em; border-radius:10px; margin-left:auto;">Available</span>' : 
                details.is_preloaded ? 
                  '<span style="font-size:0.8em; background:#6c757d; color:white; padding:0.2em 0.5em; border-radius:10px; margin-left:auto;">Pre-loaded Document</span>' :
                  '<span style="font-size:0.8em; background:#dc3545; color:white; padding:0.2em 0.5em; border-radius:10px; margin-left:auto;">Not Found</span>'
              }
            </h6>
            ${details.original_filename ? `
              <div style="margin:0.5rem 0;">
                <div><strong>Filename:</strong> ${details.original_filename}</div>
                ${details.original_file_exists ? `
                  <div style="margin-top:0.5rem;">
                    <button onclick="window.open('/static/uploads/${details.original_filename}', '_blank')" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-download"></i> Download
                    </button>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            ${!details.original_file_exists && !details.is_preloaded ? 
              '<div style="color:#dc3545; font-size:0.9em; margin-top:0.5rem;">' +
                '<i class="fas fa-exclamation-triangle"></i> Original file not found in the system.' +
              '</div>' : 
              !details.original_file_exists && details.is_preloaded ?
              '<div style="color:#6c757d; font-size:0.9em; margin-top:0.5rem;">' +
                '<i class="fas fa-info-circle"></i> This is a pre-loaded document. The original file is not available for download.' +
              '</div>' : ''}
          </div>
          
          <!-- Generated Markdown -->
          <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 1rem; background: white;">
            <h6 style="margin-top:0; color:#495057; display:flex; align-items:center; gap:0.5rem;">
              <i class="fas fa-file-alt" style="color:#6c757d;"></i>
              <span>Generated Markdown</span>
              ${details.generated_file_exists ? 
                '<span style="font-size:0.8em; background:#28a745; color:white; padding:0.2em 0.5em; border-radius:10px; margin-left:auto;">Available</span>' : 
                '<span style="font-size:0.8em; background:#dc3545; color:white; padding:0.2em 0.5em; border-radius:10px; margin-left:auto;">Not Found</span>'
              }
            </h6>
            ${details.generated_filename ? `
              <div style="margin:0.5rem 0;">
                <div><strong>Filename:</strong> ${details.generated_filename}</div>
                ${details.generated_file_exists ? `
                  <div style="margin-top:0.5rem;">
                    <button onclick="window.open('/static/knowledge_base/${details.generated_filename}', '_blank')" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-download"></i> Download
                    </button>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            ${!details.generated_file_exists ? 
              '<div style="color:#dc3545; font-size:0.9em; margin-top:0.5rem;">' +
                '<i class="fas fa-exclamation-triangle"></i> Generated markdown file not found.' +
              '</div>' : ''}
          ${metadataHtml}
        </table>
      </div>
      
      <!-- Document Statistics -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
        <div style="background:#f8f9fa; padding:1rem; border-radius:6px; text-align:center;">
          <div style="font-size:1.5rem; font-weight:bold; color:#17a2b8;">${details.word_count ? details.word_count.toLocaleString() : '0'}</div>
          <small style="color:#666;">Words</small>
        </div>
        <div style="background:#f8f9fa; padding:1rem; border-radius:6px; text-align:center;">
          <div style="font-size:1.5rem; font-weight:bold; color:#6f42c1;">${details.character_count ? details.character_count.toLocaleString() : '0'}</div>
          <small style="color:#666;">Characters</small>
        </div>
        <div style="background:#f8f9fa; padding:1rem; border-radius:6px; text-align:center;">
          <div style="font-size:1.5rem; font-weight:bold; color:#20c997;">${details.insights_extracted || details.insights_count || '0'}</div>
          <small style="color:#666;">Insights</small>
        </div>
      </div>
      
      <!-- Quality Dimensions -->
      ${qualityDimensionsHtml ? `
      <div style="margin-bottom:1.5rem; background:#f8f9fa; padding:1rem; border-radius:6px;">
        <h5 style="margin-bottom:1rem; color:#495057;">Quality Assessment</h5>
        ${qualityDimensionsHtml}
      </div>
      ` : ''}
      
      <!-- Insights -->
      ${insightsHtml ? `
      <div style="margin-bottom:1.5rem;">
        <h5 style="margin-bottom:1rem; color:#495057;">Extracted Insights (${details.insights_extracted || details.insights_count || 0})</h5>
        <div style="max-height:300px; overflow-y:auto; padding-right:0.5rem;">
          ${insightsHtml}
        </div>
      </div>
      ` : ''}
      
      <!-- Raw Data (for debugging) -->
      <div style="margin-top:1.5rem; font-size:0.8rem; color:#6c757d;">
        <details>
          <summary>View Raw Data</summary>
          <pre style="background:#f8f9fa; padding:0.75rem; border-radius:4px; max-height:200px; overflow:auto; margin-top:0.5rem;">
${JSON.stringify(details, null, 2)}
          </pre>
        </details>
      </div>
    </div>
  `;
  
  document.getElementById('documentDetailsContent').innerHTML = content;
  
  // Scroll to top of the content
  const contentDiv = document.getElementById('documentDetailsContent');
  if (contentDiv) {
    contentDiv.scrollTop = 0;
  }
}

function closeDocumentDetails() {
  const modal = document.getElementById('documentDetailsModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = ''; // Re-enable scrolling
  } else {
    console.warn('closeDocumentDetails: Modal not found');
  }
}

function createDocumentModal() {
  try {
    // Check if modal already exists
    let modal = document.getElementById('documentDetailsModal');
    if (modal) {
      return modal;
    }
    
    // Create the modal element
    modal = document.createElement('div');
    modal.id = 'documentDetailsModal';
    modal.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;';
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:2rem; border-radius:8px; max-width:600px; width:90%; max-height:80%; overflow-y:auto;';
    
    // Add modal header
    const header = document.createElement('h3');
    header.textContent = 'Document Details';
    header.style.marginBottom = '1rem';
    
    // Add content container
    const contentDiv = document.createElement('div');
    contentDiv.id = 'documentDetailsContent';
    contentDiv.textContent = 'Loading...';
    
    // Add close button
    const buttonContainer = document.createElement('div');
    buttonContainer.style.textAlign = 'center';
    buttonContainer.style.marginTop = '1.5rem';
    
    const closeButton = document.createElement('button');
    closeButton.className = 'btn btn-secondary';
    closeButton.textContent = 'Close';
    closeButton.onclick = closeDocumentDetails;
    
    // Assemble the modal
    buttonContainer.appendChild(closeButton);
    modalContent.appendChild(header);
    modalContent.appendChild(contentDiv);
    modalContent.appendChild(buttonContainer);
    modal.appendChild(modalContent);
    
    // Add to document
    document.body.appendChild(modal);
    
    // Close when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeDocumentDetails();
      }
    });
    
    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDocumentDetails();
      }
    });
    
    return modal;
  } catch (error) {
    console.error('Error creating document modal:', error);
    return null;
  }
}
</script>

        <!-- Back to Literature Management Button -->
        <div class="form-actions" style="text-align: center; margin-top: 2rem; padding: 2rem; border-top: 1px solid #e9ecef;">
            <a href="{{ url_for('admin.literature_dashboard') }}" class="btn btn-secondary">
                ← Back to Literature Management
            </a>
        </div>

{% endblock %}
